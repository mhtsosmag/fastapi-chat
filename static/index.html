<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FastAPI Chat</title>

<style>
/* Reset */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(to right, #4facfe, #00f2fe);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #333;
}

.container {
    background: #fff;
    width: 100%;
    max-width: 600px;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    display: flex;
    flex-direction: column;
    gap: 15px;
}

h2 {
    text-align: center;
    color: #4facfe;
}

.input-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.input-group input {
    flex: 1;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
}

.input-group button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    background: #4facfe;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

.input-group button:hover {
    background: #00f2fe;
}

#chat {
    height: 280px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    overflow-y: auto;
    background: #f9f9f9;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

#chat p {
    padding: 6px 10px;
    border-radius: 8px;
    max-width: 80%;
}

.system {
    background: #e0e0e0;
    text-align: center;
    font-style: italic;
}

.self {
    background: #4facfe;
    color: white;
    align-self: flex-end;
}

.other {
    background: #00f2fe;
    color: white;
    align-self: flex-start;
}

/* MESSAGE BAR */
.message-area {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* EMOJI */
.emoji-wrapper {
    position: relative;
}

#emojiBtn {
    font-size: 22px;
    background: none;
    border: none;
    cursor: pointer;
}

.emoji-panel {
    position: absolute;
    bottom: 40px;
    left: 0;
    background: white;
    border-radius: 10px;
    padding: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    display: none;
    flex-wrap: wrap;
    gap: 6px;
    width: 220px;
}

.emoji-panel span {
    cursor: pointer;
    font-size: 20px;
}

#message {
    flex: 1;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
}

#sendBtn {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    background: #4facfe;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

#sendBtn:hover {
    background: #00f2fe;
}

#users {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 8px;
    background: #f4f4f4;
}
</style>
</head>

<body>

<div class="container">
    <h2>FastAPI Chat</h2>

    <div class="input-group">
        <input id="room" placeholder="Room">
        <input id="username" placeholder="Username">
        <button id="connectBtn">Connect</button>
        <button id="logoutBtn" disabled>Log Out</button>
    </div>

    <div id="chat"></div>

    <div class="message-area">
        <div class="emoji-wrapper">
            <button id="emojiBtn">ğŸ˜Š</button>
            <div id="emojiPanel" class="emoji-panel">
                ğŸ˜€ ğŸ˜ ğŸ˜‚ ğŸ¤£ ğŸ˜Š ğŸ˜ ğŸ˜ ğŸ˜˜ ğŸ˜œ ğŸ¤” ğŸ˜¢ ğŸ˜­ ğŸ˜¡ ğŸ‘ ğŸ‘ ğŸ‘ ğŸ™Œ ğŸ‰ â¤ï¸ ğŸ”¥ ğŸš€
            </div>
        </div>

        <input id="message" placeholder="Type message...">
        <button id="sendBtn">Send</button>
    </div>

    <h4>Active Users</h4>
    <div id="users"></div>
</div>

<script>
let chatWs = null;
let usersWs = null;

const chatDiv = document.getElementById("chat");
const usersDiv = document.getElementById("users");
const messageInput = document.getElementById("message");
const connectBtn = document.getElementById("connectBtn");
const logoutBtn = document.getElementById("logoutBtn");

/* CHAT */
function appendMessage(msg, type="system") {
    const p = document.createElement("p");
    p.textContent = msg;
    p.className = type;
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

connectBtn.onclick = () => {
    const room = document.getElementById("room").value || "room1";
    const username = document.getElementById("username").value || "user";

    const proto = location.protocol === "https:" ? "wss" : "ws";

    chatWs = new WebSocket(`${proto}://${location.host}/ws/chat/${room}/${username}`);
    usersWs = new WebSocket(`${proto}://${location.host}/ws/users/${room}`);

    chatWs.onmessage = e => {
        const msg = e.data;
        if (msg.startsWith(username + ":")) appendMessage(msg, "self");
        else if (msg.includes("joined") || msg.includes("left")) appendMessage(msg, "system");
        else appendMessage(msg, "other");
    };

    usersWs.onmessage = e => {
        const users = JSON.parse(e.data);
        usersDiv.innerHTML = users.map(u => `<p>${u}</p>`).join("");
    };

    appendMessage(`ğŸ”µ You joined as ${username}`, "system");
    connectBtn.disabled = true;
    logoutBtn.disabled = false;
};

logoutBtn.onclick = () => {
    if (chatWs) chatWs.close();
    if (usersWs) usersWs.close();
    appendMessage("ğŸ”´ You left. Reloading...", "system");
    setTimeout(() => location.reload(), 3000);
};

document.getElementById("sendBtn").onclick = () => {
    if (chatWs && messageInput.value.trim()) {
        chatWs.send(messageInput.value);
        messageInput.value = "";
    }
};

messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter") document.getElementById("sendBtn").click();
});

/* EMOJI LOGIC */
const emojiBtn = document.getElementById("emojiBtn");
const emojiPanel = document.getElementById("emojiPanel");

emojiPanel.innerHTML = emojiPanel.textContent
    .split(" ")
    .map(e => `<span>${e}</span>`)
    .join("");

emojiBtn.onclick = () => {
    emojiPanel.style.display =
        emojiPanel.style.display === "flex" ? "none" : "flex";
};

emojiPanel.onclick = e => {
    if (e.target.tagName === "SPAN") {
        messageInput.value += e.target.textContent;
        messageInput.focus();
    }
};

document.addEventListener("click", e => {
    if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
        emojiPanel.style.display = "none";
    }
});
</script>

</body>
</html>
